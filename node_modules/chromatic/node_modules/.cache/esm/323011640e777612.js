let reportBuilder,path,createTask,transitionTo,baseStorybookUrl,wroteReport,initial,pending,success;_0e7‍.x([["generateReport",()=>generateReport],["default",()=>_0e7‍.o]]);_0e7‍.w("junit-report-builder",[["default",["reportBuilder"],function(v){reportBuilder=v}]]);_0e7‍.w("path",[["default",["path"],function(v){path=v}]]);_0e7‍.w("../lib/tasks",[["createTask",["createTask"],function(v){createTask=v}],["transitionTo",["transitionTo"],function(v){transitionTo=v}]]);_0e7‍.w("../lib/utils",[["baseStorybookUrl",["baseStorybookUrl"],function(v){baseStorybookUrl=v}]]);_0e7‍.w("../ui/messages/info/wroteReport",[["default",["wroteReport"],function(v){wroteReport=v}]]);_0e7‍.w("../ui/tasks/report",[["initial",["initial"],function(v){initial=v}],["pending",["pending"],function(v){pending=v}],["success",["success"],function(v){success=v}]]);







const ReportQuery = `
  query ReportQuery($buildNumber: Int!) {
    app {
      build(number: $buildNumber) {
        number
        status(legacy: false)
        webUrl
        cachedUrl
        createdAt
        completedAt
        tests {
          status
          result
          spec {
            name
            component {
              name
              displayName
            }
          }
          parameters {
            viewport
            viewportIsDefault
          }
        }
      }
    }
  }
`;

       const generateReport = async (ctx) => {
  const { client, log } = ctx;
  const { junitReport } = ctx.options;
  const { number: buildNumber, reportToken } = ctx.build;

  const file = junitReport === true ? 'chromatic-build-{buildNumber}.xml' : junitReport;
  ctx.reportPath = path.resolve(file.replace(/{buildNumber}/g, buildNumber));

  const {
    app: { build },
  } = await client.runQuery(
    ReportQuery,
    { buildNumber },
    { Authorization: `Bearer ${reportToken}` }
  );
  const buildTime = (build.completedAt || Date.now()) - build.createdAt;

  const suite = reportBuilder
    .testSuite()
    .name(`Chromatic build ${build.number}`)
    .time(Math.round(buildTime / 1000))
    .timestamp(new Date(build.createdAt).toISOString())
    .property('buildNumber', build.number)
    .property('buildStatus', build.status)
    .property('buildUrl', build.webUrl)
    .property('storybookUrl', baseStorybookUrl(build.cachedUrl));

  build.tests.forEach(({ status, result, spec, parameters }) => {
    const suffix = parameters.viewportIsDefault ? '' : ` [${parameters.viewport}px]`;
    const testCase = suite
      .testCase()
      .className(spec.component.name.replace(/[|/]/g, '.')) // transform story path to class path
      .name(`${spec.name}${suffix}`);

    switch (status) {
      case 'FAILED':
        testCase.error('Server error while taking snapshot, please try again', status);
        break;
      case 'BROKEN':
        testCase.error('Snapshot is broken due to an error in your Storybook', status);
        break;
      case 'DENIED':
        testCase.failure('Snapshot was denied by a user', status);
        break;
      case 'PENDING':
        testCase.failure('Snapshot contains visual changes and must be reviewed', status);
        break;
      default: {
        if (['SKIPPED', 'PRESERVED'].includes(result)) {
          testCase.skipped();
        }
      }
    }
  });

  reportBuilder.writeTo(ctx.reportPath);
  log.info(wroteReport(ctx.reportPath));
};

_0e7‍.d(createTask({
  title: initial.title,
  skip: (ctx) => ctx.skip,
  steps: [transitionTo(pending), generateReport, transitionTo(success, true)],
}));
